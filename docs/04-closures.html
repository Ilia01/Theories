<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closures</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
    <!-- Header Toolbar -->
    <div id="header-toolbar">
        <button id="search-trigger" aria-label="Search" title="Search (Cmd+K)">
            <i class="fas fa-search"></i>
        </button>
        <button id="dark-mode-toggle" aria-label="Toggle dark mode" title="Toggle Dark Mode (Cmd+D)">
            <i id="dark-mode-icon" class="fas fa-moon"></i>
        </button>
        <button id="shortcuts-help" onclick="window.Shortcuts.show()" aria-label="Keyboard shortcuts"
            title="Shortcuts (?)">
            <i class="fas fa-keyboard"></i>
        </button>
    </div>

    <!-- Mobile Menu Toggle -->
    <button id="menu-toggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Progress Bar -->
    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>

    <!-- Overall Progress Indicator -->
    <div id="overall-progress">
        <div id="overall-progress-bar" style="width: 0%"></div>
        <span id="progress-text">0/0 topics completed</span>
    </div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar">
        <div id="sidebar-header">
            <h2>JS/NodeJs Concepts</h2>
        </div>
        <ul id="nav-list">
                        <li><a href="01-git-version-control.html"><span class="nav-number">1.</span>Git & Version Control</a></li>
            <li><a href="02-javascript-data-types.html"><span class="nav-number">2.</span>JavaScript Data Types</a></li>
            <li><a href="03-prototypal-inheritance.html"><span class="nav-number">3.</span>Prototypal Inheritance</a></li>
            <li><a href="04-closures.html" class="active"><span class="nav-number">4.</span>Closures</a></li>
            <li><a href="05-context.html"><span class="nav-number">5.</span>Context (this)</a></li>
            <li><a href="06-classes.html"><span class="nav-number">6.</span>Classes</a></li>
            <li><a href="07-event-loop-async.html"><span class="nav-number">7.</span>Event Loop & Async</a></li>
            <li><a href="08-garbage-collection.html"><span class="nav-number">8.</span>Garbage Collection</a></li>
        </ul>
        <div id="sidebar-footer">
            <button id="reset-progress" class="sidebar-btn">Reset Progress</button>
            <button id="export-progress" class="sidebar-btn">Export</button>
            <button id="flashcards-btn" class="sidebar-btn">
                <i class="fas fa-layer-group"></i> Flashcards
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        
        <aside class="table-of-contents">
            <h3>On This Page</h3>
            <nav class="toc-nav">
                <ul><li class=""><a href="#table-of-contents">Table of Contents</a></li>
<li class=""><a href="#basic-definition-and-concept">Basic Definition and Concept</a></li>
<li class="toc-sub"><a href="#what-is-a-closure">What is a Closure?</a></li>
<li class="toc-sub"><a href="#simple-example">Simple Example</a></li>
<li class="toc-sub"><a href="#how-it-works">How It Works</a></li>
<li class="toc-sub"><a href="#lexical-scoping">Lexical Scoping</a></li>
<li class=""><a href="#practical-scenarios">Practical Scenarios</a></li>
<li class="toc-sub"><a href="#1-data-privacy-encapsulation">1. Data Privacy / Encapsulation</a></li>
<li class="toc-sub"><a href="#2-function-factories">2. Function Factories</a></li>
<li class="toc-sub"><a href="#3-event-handlers-and-callbacks">3. Event Handlers and Callbacks</a></li>
<li class="toc-sub"><a href="#4-partial-application-and-currying">4. Partial Application and Currying</a></li>
<li class="toc-sub"><a href="#5-module-pattern">5. Module Pattern</a></li>
<li class="toc-sub"><a href="#6-iterator-pattern">6. Iterator Pattern</a></li>
<li class=""><a href="#importance-of-closures">Importance of Closures</a></li>
<li class="toc-sub"><a href="#1-data-privacy">1. Data Privacy</a></li>
<li class="toc-sub"><a href="#2-functional-programming">2. Functional Programming</a></li>
<li class="toc-sub"><a href="#3-callbacks-and-event-handling">3. Callbacks and Event Handling</a></li>
<li class="toc-sub"><a href="#4-maintaining-state">4. Maintaining State</a></li>
<li class=""><a href="#common-issues-and-pitfalls">Common Issues and Pitfalls</a></li>
<li class="toc-sub"><a href="#1-loop-closure-problem">1. Loop Closure Problem</a></li>
<li class="toc-sub"><a href="#2-memory-leaks">2. Memory Leaks</a></li>
<li class="toc-sub"><a href="#3-accidental-global-variables">3. Accidental Global Variables</a></li>
<li class="toc-sub"><a href="#4-over-closure">4. Over-Closure</a></li>
<li class="toc-sub"><a href="#5-closure-in-callbacks-with-wrong-context">5. Closure in Callbacks with Wrong Context</a></li>
<li class=""><a href="#example-implementations">Example Implementations</a></li>
<li class="toc-sub"><a href="#1-private-variables-with-closures">1. Private Variables with Closures</a></li>
<li class="toc-sub"><a href="#2-memoization-caching">2. Memoization (Caching)</a></li>
<li class="toc-sub"><a href="#3-once-function">3. Once Function</a></li>
<li class="toc-sub"><a href="#4-debounce-function">4. Debounce Function</a></li>
<li class="toc-sub"><a href="#5-throttle-function">5. Throttle Function</a></li>
<li class="toc-sub"><a href="#6-counter-with-multiple-operations">6. Counter with Multiple Operations</a></li>
<li class=""><a href="#writing-and-analyzing-closures">Writing and Analyzing Closures</a></li>
<li class="toc-sub"><a href="#analysis-checklist">Analysis Checklist</a></li>
<li class="toc-sub"><a href="#example-analysis">Example Analysis</a></li>
<li class="toc-sub"><a href="#scope-encapsulation-pattern">Scope Encapsulation Pattern</a></li>
<li class="toc-sub"><a href="#advanced-closure-with-private-state-and-methods">Advanced: Closure with Private State and Methods</a></li>
<li class="toc-sub"><a href="#closure-scope-diagram">Closure Scope Diagram</a></li>
<li class=""><a href="#summary">Summary</a></li>
<li class="toc-sub"><a href="#key-takeaways">Key Takeaways</a></li>
<li class="toc-sub"><a href="#best-practices">Best Practices</a></li>
<li class="toc-sub"><a href="#common-patterns">Common Patterns</a></li>
<li class="toc-sub"><a href="#interview-questions-to-prepare">Interview Questions to Prepare</a></li></ul>
            </nav>
        </aside>
    
        <div class="page-meta">
            <span class="reading-time"><i class="far fa-clock"></i> 16 min read</span>
        </div>
    <h1 id="closures">Closures</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#basic-definition-and-concept">Basic Definition and Concept</a></li>
<li><a href="#practical-scenarios">Practical Scenarios</a></li>
<li><a href="#importance-of-closures">Importance of Closures</a></li>
<li><a href="#common-issues-and-pitfalls">Common Issues and Pitfalls</a></li>
<li><a href="#example-implementations">Example Implementations</a></li>
<li><a href="#writing-and-analyzing-closures">Writing and Analyzing Closures</a></li>
</ul>
<hr>
<h2 id="basic-definition-and-concept">Basic Definition and Concept</h2>
<h3 id="what-is-a-closure">What is a Closure?</h3>
<p>A <strong>closure</strong> is a function bundled together with references to its surrounding state (lexical environment).</p>
<p><strong>Key Points:</strong></p>
<ul>
<li>Function retains access to variables from outer scope</li>
<li>Even after the outer function has returned</li>
<li>Created every time a function is created</li>
<li>Lexical scoping (based on where variables are declared)</li>
</ul>
<h3 id="simple-example">Simple Example</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> message = <span class="hljs-string">&quot;Hello&quot;</span>;  <span class="hljs-comment">// Variable in outer scope</span>

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);  <span class="hljs-comment">// Accesses outer variable</span>
  }

  <span class="hljs-keyword">return</span> inner;
}

<span class="hljs-keyword">const</span> myFunc = <span class="hljs-title function_">outer</span>();
<span class="hljs-title function_">myFunc</span>(); <span class="hljs-comment">// &quot;Hello&quot; - closure preserved access to message</span>
</code></pre><h3 id="how-it-works">How It Works</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">makeCounter</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;  <span class="hljs-comment">// Private variable</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    count++;  <span class="hljs-comment">// Closure: access to count</span>
    <span class="hljs-keyword">return</span> count;
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">makeCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 3</span>

<span class="hljs-comment">// Each call to makeCounter creates a new closure</span>
<span class="hljs-keyword">const</span> counter2 = <span class="hljs-title function_">makeCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter2</span>()); <span class="hljs-comment">// 1 (independent count)</span>
</code></pre><h3 id="lexical-scoping">Lexical Scoping</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">&quot;global&quot;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> outerVar = <span class="hljs-string">&quot;outer&quot;</span>;

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">middle</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> middleVar = <span class="hljs-string">&quot;middle&quot;</span>;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">const</span> innerVar = <span class="hljs-string">&quot;inner&quot;</span>;

      <span class="hljs-comment">// Inner function has access to ALL outer scopes</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar);   <span class="hljs-comment">// &quot;inner&quot;</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(middleVar);  <span class="hljs-comment">// &quot;middle&quot;</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar);   <span class="hljs-comment">// &quot;outer&quot;</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar);  <span class="hljs-comment">// &quot;global&quot;</span>
    }

    <span class="hljs-keyword">return</span> inner;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">middle</span>();
}

<span class="hljs-keyword">const</span> myFunc = <span class="hljs-title function_">outer</span>();
<span class="hljs-title function_">myFunc</span>();
</code></pre><hr>
<h2 id="practical-scenarios">Practical Scenarios</h2>
<h3 id="1-data-privacy-encapsulation">1. Data Privacy / Encapsulation</h3>
<p>Create private variables that can&#39;t be accessed directly.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createBankAccount</span>(<span class="hljs-params">initialBalance</span>) {
  <span class="hljs-comment">// Private variable</span>
  <span class="hljs-keyword">let</span> balance = initialBalance;

  <span class="hljs-comment">// Public interface</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">deposit</span>(<span class="hljs-params">amount</span>) {
      <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">0</span>) {
        balance += amount;
        <span class="hljs-keyword">return</span> balance;
      }
    },

    <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">amount</span>) {
      <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">0</span> &amp;&amp; amount &lt;= balance) {
        balance -= amount;
        <span class="hljs-keyword">return</span> balance;
      }
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Insufficient funds&quot;</span>);
    },

    <span class="hljs-title function_">getBalance</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> balance;
    }
  };
}

<span class="hljs-keyword">const</span> account = <span class="hljs-title function_">createBankAccount</span>(<span class="hljs-number">100</span>);
account.<span class="hljs-title function_">deposit</span>(<span class="hljs-number">50</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(account.<span class="hljs-title function_">getBalance</span>());  <span class="hljs-comment">// 150</span>
account.<span class="hljs-title function_">withdraw</span>(<span class="hljs-number">30</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(account.<span class="hljs-title function_">getBalance</span>());  <span class="hljs-comment">// 120</span>

<span class="hljs-comment">// balance is private - no direct access</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(account.<span class="hljs-property">balance</span>);  <span class="hljs-comment">// undefined</span>
<span class="hljs-comment">// account.balance = 99999;  // Doesn&#x27;t affect actual balance</span>
</code></pre><h3 id="2-function-factories">2. Function Factories</h3>
<p>Create specialized functions with preset configuration.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">makeMultiplier</span>(<span class="hljs-params">multiplier</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">number</span>) {
    <span class="hljs-keyword">return</span> number * multiplier;
  };
}

<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">makeMultiplier</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> triple = <span class="hljs-title function_">makeMultiplier</span>(<span class="hljs-number">3</span>);
<span class="hljs-keyword">const</span> quadruple = <span class="hljs-title function_">makeMultiplier</span>(<span class="hljs-number">4</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">double</span>(<span class="hljs-number">5</span>));      <span class="hljs-comment">// 10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">triple</span>(<span class="hljs-number">5</span>));      <span class="hljs-comment">// 15</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">quadruple</span>(<span class="hljs-number">5</span>));   <span class="hljs-comment">// 20</span>

<span class="hljs-comment">// More practical example: greeting function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeGreeter</span>(<span class="hljs-params">greeting</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>;
  };
}

<span class="hljs-keyword">const</span> sayHello = <span class="hljs-title function_">makeGreeter</span>(<span class="hljs-string">&quot;Hello&quot;</span>);
<span class="hljs-keyword">const</span> sayHi = <span class="hljs-title function_">makeGreeter</span>(<span class="hljs-string">&quot;Hi&quot;</span>);
<span class="hljs-keyword">const</span> sayGoodbye = <span class="hljs-title function_">makeGreeter</span>(<span class="hljs-string">&quot;Goodbye&quot;</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayHello</span>(<span class="hljs-string">&quot;Alice&quot;</span>));    <span class="hljs-comment">// &quot;Hello, Alice!&quot;</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayHi</span>(<span class="hljs-string">&quot;Bob&quot;</span>));         <span class="hljs-comment">// &quot;Hi, Bob!&quot;</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayGoodbye</span>(<span class="hljs-string">&quot;Charlie&quot;</span>)); <span class="hljs-comment">// &quot;Goodbye, Charlie!&quot;</span>
</code></pre><h3 id="3-event-handlers-and-callbacks">3. Event Handlers and Callbacks</h3>
<p>Preserve context and data for async operations.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setupButtons</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> buttons = [<span class="hljs-string">&quot;Login&quot;</span>, <span class="hljs-string">&quot;Signup&quot;</span>, <span class="hljs-string">&quot;Logout&quot;</span>];

  buttons.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">buttonText, index</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;button&#x27;</span>);
    button.<span class="hljs-property">textContent</span> = buttonText;

    <span class="hljs-comment">// Closure preserves buttonText and index</span>
    button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Button <span class="hljs-subst">${index}</span>: <span class="hljs-subst">${buttonText}</span> clicked`</span>);
    });

    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(button);
  });
}

<span class="hljs-comment">// Another example: timer with specific message</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">delayedMessage</span>(<span class="hljs-params">message, delay</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);  <span class="hljs-comment">// Closure over message</span>
  }, delay);
}

<span class="hljs-title function_">delayedMessage</span>(<span class="hljs-string">&quot;First&quot;</span>, <span class="hljs-number">1000</span>);
<span class="hljs-title function_">delayedMessage</span>(<span class="hljs-string">&quot;Second&quot;</span>, <span class="hljs-number">2000</span>);
<span class="hljs-title function_">delayedMessage</span>(<span class="hljs-string">&quot;Third&quot;</span>, <span class="hljs-number">3000</span>);
</code></pre><h3 id="4-partial-application-and-currying">4. Partial Application and Currying</h3>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// Partial application</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">return</span> a + b + c;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">partial</span>(<span class="hljs-params">fn, ...fixedArgs</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...remainingArgs</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...fixedArgs, ...remainingArgs);
  };
}

<span class="hljs-keyword">const</span> add5 = <span class="hljs-title function_">partial</span>(add, <span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add5</span>(<span class="hljs-number">10</span>, <span class="hljs-number">15</span>)); <span class="hljs-comment">// 30 (5 + 10 + 15)</span>

<span class="hljs-comment">// Currying</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">curry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt;= fn.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...nextArgs</span>) {
      <span class="hljs-keyword">return</span> curried.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args.<span class="hljs-title function_">concat</span>(nextArgs));
    };
  };
}

<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>));     <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)(<span class="hljs-number">3</span>));     <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));     <span class="hljs-comment">// 6</span>
</code></pre><h3 id="5-module-pattern">5. Module Pattern</h3>
<p>Create modules with private and public members.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Calculator</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// Private variables and functions</span>
  <span class="hljs-keyword">let</span> result = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateNumber</span>(<span class="hljs-params">n</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> n !== <span class="hljs-string">&#x27;number&#x27;</span> || <span class="hljs-built_in">isNaN</span>(n)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Invalid number&#x27;</span>);
    }
  }

  <span class="hljs-comment">// Public API</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">add</span>(<span class="hljs-params">n</span>) {
      <span class="hljs-title function_">validateNumber</span>(n);
      result += n;
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    },

    <span class="hljs-title function_">subtract</span>(<span class="hljs-params">n</span>) {
      <span class="hljs-title function_">validateNumber</span>(n);
      result -= n;
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    },

    <span class="hljs-title function_">multiply</span>(<span class="hljs-params">n</span>) {
      <span class="hljs-title function_">validateNumber</span>(n);
      result *= n;
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    },

    <span class="hljs-title function_">getResult</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> result;
    },

    <span class="hljs-title function_">reset</span>(<span class="hljs-params"></span>) {
      result = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }
  };
})();

<span class="hljs-title class_">Calculator</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">10</span>).<span class="hljs-title function_">multiply</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">subtract</span>(<span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Calculator</span>.<span class="hljs-title function_">getResult</span>());  <span class="hljs-comment">// 15</span>
<span class="hljs-title class_">Calculator</span>.<span class="hljs-title function_">reset</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Calculator</span>.<span class="hljs-title function_">getResult</span>());  <span class="hljs-comment">// 0</span>

<span class="hljs-comment">// Private members are not accessible</span>
<span class="hljs-comment">// Calculator.result;  // undefined</span>
<span class="hljs-comment">// Calculator.validateNumber(5);  // Error</span>
</code></pre><h3 id="6-iterator-pattern">6. Iterator Pattern</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createIterator</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">next</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">if</span> (index &lt; array.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">value</span>: array[index++],
          <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>
        };
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
    },

    <span class="hljs-title function_">hasNext</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> index &lt; array.<span class="hljs-property">length</span>;
    },

    <span class="hljs-title function_">reset</span>(<span class="hljs-params"></span>) {
      index = <span class="hljs-number">0</span>;
    }
  };
}

<span class="hljs-keyword">const</span> iterator = <span class="hljs-title function_">createIterator</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 2, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator.<span class="hljs-title function_">hasNext</span>()); <span class="hljs-comment">// true</span>
iterator.<span class="hljs-title function_">reset</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 1, done: false }</span>
</code></pre><hr>
<h2 id="importance-of-closures">Importance of Closures</h2>
<h3 id="1-data-privacy">1. Data Privacy</h3>
<p>Enable true private variables in JavaScript.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">let</span> _password = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// Private</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> name;
    },

    <span class="hljs-title function_">setPassword</span>(<span class="hljs-params">pwd</span>) {
      _password = pwd;
    },

    <span class="hljs-title function_">checkPassword</span>(<span class="hljs-params">pwd</span>) {
      <span class="hljs-keyword">return</span> _password === pwd;
    }
  };
}

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">createUser</span>(<span class="hljs-string">&quot;Alice&quot;</span>);
user.<span class="hljs-title function_">setPassword</span>(<span class="hljs-string">&quot;secret123&quot;</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-title function_">checkPassword</span>(<span class="hljs-string">&quot;secret123&quot;</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">_password</span>);  <span class="hljs-comment">// undefined (truly private)</span>
</code></pre><h3 id="2-functional-programming">2. Functional Programming</h3>
<p>Foundation for many FP patterns.</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// Higher-order functions</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">compose</span> = (<span class="hljs-params">...fns</span>) =&gt; <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span>
  fns.<span class="hljs-title function_">reduceRight</span>(<span class="hljs-function">(<span class="hljs-params">acc, fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(acc), x);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">add1</span> = x =&gt; x + <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">double</span> = x =&gt; x * <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">square</span> = x =&gt; x * x;

<span class="hljs-keyword">const</span> compute = <span class="hljs-title function_">compose</span>(square, double, add1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">compute</span>(<span class="hljs-number">3</span>));  <span class="hljs-comment">// 64: ((3 + 1) * 2)^2 = (8)^2</span>
</code></pre><h3 id="3-callbacks-and-event-handling">3. Callbacks and Event Handling</h3>
<p>Essential for asynchronous programming.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">url, onSuccess, onError</span>) {
  <span class="hljs-comment">// Closures preserve onSuccess and onError</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (url) {
      <span class="hljs-title function_">onSuccess</span>({ <span class="hljs-attr">data</span>: <span class="hljs-string">&quot;Success!&quot;</span> });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">onError</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Invalid URL&quot;</span>));
    }
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-title function_">fetchData</span>(
  <span class="hljs-string">&quot;https://api.example.com&quot;</span>,
  <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">data</span>),
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>)
);
</code></pre><h3 id="4-maintaining-state">4. Maintaining State</h3>
<p>Without global variables.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createGame</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">let</span> score = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> level = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> lives = <span class="hljs-number">3</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">increaseScore</span>(<span class="hljs-params">points</span>) {
      score += points;
      <span class="hljs-keyword">if</span> (score &gt; level * <span class="hljs-number">100</span>) {
        level++;
      }
    },

    <span class="hljs-title function_">loseLife</span>(<span class="hljs-params"></span>) {
      lives--;
      <span class="hljs-keyword">if</span> (lives === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gameOver</span>();
      }
    },

    <span class="hljs-title function_">gameOver</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Game Over! Final score: <span class="hljs-subst">${score}</span>, Level: <span class="hljs-subst">${level}</span>`</span>);
    },

    <span class="hljs-title function_">getStatus</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> { score, level, lives };
    }
  };
}

<span class="hljs-keyword">const</span> game = <span class="hljs-title function_">createGame</span>();
game.<span class="hljs-title function_">increaseScore</span>(<span class="hljs-number">50</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(game.<span class="hljs-title function_">getStatus</span>());  <span class="hljs-comment">// { score: 50, level: 1, lives: 3 }</span>
</code></pre><hr>
<h2 id="common-issues-and-pitfalls">Common Issues and Pitfalls</h2>
<h3 id="1-loop-closure-problem">1. Loop Closure Problem</h3>
<p><strong>The Problem:</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ❌ WRONG: All callbacks reference the same i</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i);  <span class="hljs-comment">// 3, 3, 3 (not 0, 1, 2!)</span>
  }, <span class="hljs-number">100</span>);
}

<span class="hljs-comment">// Why? By the time callbacks run, loop has finished</span>
<span class="hljs-comment">// All callbacks share the same i, which is now 3</span>
</code></pre><p><strong>Solution 1: IIFE (Immediately Invoked Function Expression)</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ✅ CORRECT: IIFE creates new scope for each iteration</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  (<span class="hljs-keyword">function</span>(<span class="hljs-params">j</span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(j);  <span class="hljs-comment">// 0, 1, 2</span>
    }, <span class="hljs-number">100</span>);
  })(i);
}
</code></pre><p><strong>Solution 2: let (Block Scope)</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ✅ CORRECT: let creates new binding for each iteration</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i);  <span class="hljs-comment">// 0, 1, 2</span>
  }, <span class="hljs-number">100</span>);
}
</code></pre><p><strong>Solution 3: forEach</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ✅ CORRECT: forEach callback creates new scope</span>
[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i);  <span class="hljs-comment">// 0, 1, 2</span>
  }, <span class="hljs-number">100</span>);
});
</code></pre><h3 id="2-memory-leaks">2. Memory Leaks</h3>
<p>Closures keep references to variables, which can prevent garbage collection.</p>
<p><strong>Problem:</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ❌ Memory leak: closure keeps reference to large data</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createHandler</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> largeData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">&#x27;data&#x27;</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(largeData.<span class="hljs-property">length</span>);  <span class="hljs-comment">// Entire array kept in memory</span>
  };
}

<span class="hljs-keyword">const</span> handler = <span class="hljs-title function_">createHandler</span>();
<span class="hljs-comment">// largeData can&#x27;t be garbage collected</span>
</code></pre><p><strong>Solution:</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ✅ Reference only what you need</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createHandler</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> largeData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">&#x27;data&#x27;</span>);
  <span class="hljs-keyword">const</span> dataLength = largeData.<span class="hljs-property">length</span>;  <span class="hljs-comment">// Extract needed value</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dataLength);  <span class="hljs-comment">// Only number kept in memory</span>
  };
}

<span class="hljs-keyword">const</span> handler = <span class="hljs-title function_">createHandler</span>();
<span class="hljs-comment">// largeData can now be garbage collected</span>
</code></pre><h3 id="3-accidental-global-variables">3. Accidental Global Variables</h3>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ❌ Forgot var/let/const - creates global!</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"></span>) {
  count = <span class="hljs-number">0</span>;  <span class="hljs-comment">// Oops! Global variable</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    count++;
    <span class="hljs-keyword">return</span> count;
  };
}

<span class="hljs-keyword">const</span> counter1 = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-keyword">const</span> counter2 = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter1</span>());  <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter2</span>());  <span class="hljs-comment">// 2 (shared global count!)</span>
</code></pre><p><strong>Solution:</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ✅ Always use var/let/const</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;  <span class="hljs-comment">// Local variable</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    count++;
    <span class="hljs-keyword">return</span> count;
  };
}

<span class="hljs-keyword">const</span> counter1 = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-keyword">const</span> counter2 = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter1</span>());  <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter2</span>());  <span class="hljs-comment">// 1 (independent counts)</span>
</code></pre><h3 id="4-over-closure">4. Over-Closure</h3>
<p>Closing over unnecessary variables.</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// ❌ Closes over entire obj even though only need id</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGetter</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> obj.<span class="hljs-property">id</span>;  <span class="hljs-comment">// Keeps entire object in memory</span>
  };
}

<span class="hljs-comment">// ✅ Extract only what you need</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGetter</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">const</span> id = obj.<span class="hljs-property">id</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> id;  <span class="hljs-comment">// Only keeps id in memory</span>
  };
}
</code></pre><h3 id="5-closure-in-callbacks-with-wrong-context">5. Closure in Callbacks with Wrong Context</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">42</span>,

  <span class="hljs-comment">// ❌ This context lost in setTimeout</span>
  <span class="hljs-title function_">getValue</span>(<span class="hljs-params"></span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);  <span class="hljs-comment">// undefined</span>
    }, <span class="hljs-number">100</span>);
  }
};

<span class="hljs-comment">// ✅ Solution 1: Arrow function (lexical this)</span>
<span class="hljs-keyword">const</span> obj1 = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">42</span>,

  <span class="hljs-title function_">getValue</span>(<span class="hljs-params"></span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 42</span>
    }, <span class="hljs-number">100</span>);
  }
};

<span class="hljs-comment">// ✅ Solution 2: Store this reference</span>
<span class="hljs-keyword">const</span> obj2 = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">42</span>,

  <span class="hljs-title function_">getValue</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(self.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 42</span>
    }, <span class="hljs-number">100</span>);
  }
};

<span class="hljs-comment">// ✅ Solution 3: bind</span>
<span class="hljs-keyword">const</span> obj3 = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">42</span>,

  <span class="hljs-title function_">getValue</span>(<span class="hljs-params"></span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 42</span>
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">100</span>);
  }
};
</code></pre><hr>
<h2 id="example-implementations">Example Implementations</h2>
<h3 id="1-private-variables-with-closures">1. Private Variables with Closures</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">BankAccount</span>(<span class="hljs-params">initialBalance</span>) {
  <span class="hljs-comment">// Private variables</span>
  <span class="hljs-keyword">let</span> balance = initialBalance;
  <span class="hljs-keyword">const</span> transactionHistory = [];

  <span class="hljs-comment">// Private function</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">recordTransaction</span>(<span class="hljs-params">type, amount</span>) {
    transactionHistory.<span class="hljs-title function_">push</span>({
      type,
      amount,
      balance,
      <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    });
  }

  <span class="hljs-comment">// Public methods</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">deposit</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">amount</span>) {
    <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Amount must be positive&quot;</span>);
    }
    balance += amount;
    <span class="hljs-title function_">recordTransaction</span>(<span class="hljs-string">&#x27;deposit&#x27;</span>, amount);
    <span class="hljs-keyword">return</span> balance;
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">withdraw</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">amount</span>) {
    <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Amount must be positive&quot;</span>);
    }
    <span class="hljs-keyword">if</span> (amount &gt; balance) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Insufficient funds&quot;</span>);
    }
    balance -= amount;
    <span class="hljs-title function_">recordTransaction</span>(<span class="hljs-string">&#x27;withdraw&#x27;</span>, amount);
    <span class="hljs-keyword">return</span> balance;
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">getBalance</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> balance;
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">getHistory</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Return copy to prevent modification</span>
    <span class="hljs-keyword">return</span> [...transactionHistory];
  };
}

<span class="hljs-keyword">const</span> account = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-number">1000</span>);
account.<span class="hljs-title function_">deposit</span>(<span class="hljs-number">500</span>);
account.<span class="hljs-title function_">withdraw</span>(<span class="hljs-number">200</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(account.<span class="hljs-title function_">getBalance</span>());  <span class="hljs-comment">// 1300</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(account.<span class="hljs-title function_">getHistory</span>());  <span class="hljs-comment">// Array of transactions</span>

<span class="hljs-comment">// Private variables are truly private</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(account.<span class="hljs-property">balance</span>);  <span class="hljs-comment">// undefined</span>
</code></pre><h3 id="2-memoization-caching">2. Memoization (Caching)</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoize</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">const</span> cache = {};

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args);

    <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> cache) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Fetching from cache:&#x27;</span>, key);
      <span class="hljs-keyword">return</span> cache[key];
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Calculating result&#x27;</span>);
    <span class="hljs-keyword">const</span> result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    cache[key] = result;
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-comment">// Expensive function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fibonacci</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-title function_">fibonacci</span>(n - <span class="hljs-number">2</span>);
}

<span class="hljs-keyword">const</span> memoizedFib = <span class="hljs-title function_">memoize</span>(fibonacci);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">memoizedFib</span>(<span class="hljs-number">40</span>));  <span class="hljs-comment">// Calculating result (takes time)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">memoizedFib</span>(<span class="hljs-number">40</span>));  <span class="hljs-comment">// Fetching from cache (instant!)</span>

<span class="hljs-comment">// Another example: API call caching</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>());
}

<span class="hljs-keyword">const</span> cachedFetchUser = <span class="hljs-title function_">memoize</span>(fetchUser);
</code></pre><h3 id="3-once-function">3. Once Function</h3>
<p>Execute function only once, return cached result after.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">once</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> result;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (!called) {
      called = <span class="hljs-literal">true</span>;
      result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-keyword">const</span> initialize = <span class="hljs-title function_">once</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Initializing application...&quot;</span>);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">initialized</span>: <span class="hljs-literal">true</span> };
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">initialize</span>());  <span class="hljs-comment">// &quot;Initializing application...&quot; { initialized: true }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">initialize</span>());  <span class="hljs-comment">// { initialized: true } (no log)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">initialize</span>());  <span class="hljs-comment">// { initialized: true } (no log)</span>

<span class="hljs-comment">// Practical use: expensive initialization</span>
<span class="hljs-keyword">const</span> connectDatabase = <span class="hljs-title function_">once</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Connecting to database...&quot;</span>);
  <span class="hljs-comment">// Expensive connection logic</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">connection</span>: <span class="hljs-string">&quot;db_connection&quot;</span> };
});
</code></pre><h3 id="4-debounce-function">4. Debounce Function</h3>
<p>Delay function execution until after a pause.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timeoutId;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// Clear previous timeout</span>
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);

    <span class="hljs-comment">// Set new timeout</span>
    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }, delay);
  };
}

<span class="hljs-comment">// Example: search input</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">searchAPI</span> = (<span class="hljs-params">query</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Searching for: <span class="hljs-subst">${query}</span>`</span>);
  <span class="hljs-comment">// API call here</span>
};

<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(searchAPI, <span class="hljs-number">300</span>);

<span class="hljs-comment">// User types &quot;hello&quot;</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">&#x27;h&#x27;</span>);    <span class="hljs-comment">// Timeout set</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">&#x27;he&#x27;</span>);   <span class="hljs-comment">// Previous timeout cleared, new one set</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">&#x27;hel&#x27;</span>);  <span class="hljs-comment">// Previous timeout cleared, new one set</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">&#x27;hell&#x27;</span>); <span class="hljs-comment">// Previous timeout cleared, new one set</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">&#x27;hello&#x27;</span>);<span class="hljs-comment">// Previous timeout cleared, new one set</span>
<span class="hljs-comment">// After 300ms of no typing: &quot;Searching for: hello&quot;</span>
</code></pre><h3 id="5-throttle-function">5. Throttle Function</h3>
<p>Limit function execution to once per time period.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, limit</span>) {
  <span class="hljs-keyword">let</span> inThrottle;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (!inThrottle) {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      inThrottle = <span class="hljs-literal">true</span>;

      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        inThrottle = <span class="hljs-literal">false</span>;
      }, limit);
    }
  };
}

<span class="hljs-comment">// Example: scroll event</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Scroll position:&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);
};

<span class="hljs-keyword">const</span> throttledScroll = <span class="hljs-title function_">throttle</span>(handleScroll, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// Will only log once per second, no matter how much user scrolls</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, throttledScroll);
</code></pre><h3 id="6-counter-with-multiple-operations">6. Counter with Multiple Operations</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">let</span> count = initialValue;
  <span class="hljs-keyword">const</span> listeners = [];

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">notify</span>(<span class="hljs-params"></span>) {
    listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>(count));
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params">step = <span class="hljs-number">1</span></span>) {
      count += step;
      <span class="hljs-title function_">notify</span>();
      <span class="hljs-keyword">return</span> count;
    },

    <span class="hljs-title function_">decrement</span>(<span class="hljs-params">step = <span class="hljs-number">1</span></span>) {
      count -= step;
      <span class="hljs-title function_">notify</span>();
      <span class="hljs-keyword">return</span> count;
    },

    <span class="hljs-title function_">reset</span>(<span class="hljs-params"></span>) {
      count = initialValue;
      <span class="hljs-title function_">notify</span>();
      <span class="hljs-keyword">return</span> count;
    },

    <span class="hljs-title function_">getValue</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> count;
    },

    <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">listener</span>) {
      listeners.<span class="hljs-title function_">push</span>(listener);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> index = listeners.<span class="hljs-title function_">indexOf</span>(listener);
        <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
          listeners.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
        }
      };
    }
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>(<span class="hljs-number">10</span>);

<span class="hljs-keyword">const</span> unsubscribe = counter.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Counter changed to: <span class="hljs-subst">${value}</span>`</span>);
});

counter.<span class="hljs-title function_">increment</span>();    <span class="hljs-comment">// &quot;Counter changed to: 11&quot;</span>
counter.<span class="hljs-title function_">increment</span>(<span class="hljs-number">5</span>);   <span class="hljs-comment">// &quot;Counter changed to: 16&quot;</span>
counter.<span class="hljs-title function_">decrement</span>(<span class="hljs-number">3</span>);   <span class="hljs-comment">// &quot;Counter changed to: 13&quot;</span>
counter.<span class="hljs-title function_">reset</span>();        <span class="hljs-comment">// &quot;Counter changed to: 10&quot;</span>

<span class="hljs-title function_">unsubscribe</span>();
counter.<span class="hljs-title function_">increment</span>();    <span class="hljs-comment">// No log (unsubscribed)</span>
</code></pre><hr>
<h2 id="writing-and-analyzing-closures">Writing and Analyzing Closures</h2>
<h3 id="analysis-checklist">Analysis Checklist</h3>
<p>When analyzing closure code:</p>
<ol>
<li><strong>Identify inner function(s)</strong></li>
<li><strong>Find variables from outer scope referenced by inner function</strong></li>
<li><strong>Determine if inner function escapes outer scope</strong> (returned, assigned, passed as callback)</li>
<li><strong>Trace variable lifetime</strong> - what stays in memory?</li>
<li><strong>Check for potential memory leaks</strong> or unintended references</li>
</ol>
<h3 id="example-analysis">Example Analysis</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">makeMultiplier</span>(<span class="hljs-params">factor</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">number</span>) {
    <span class="hljs-keyword">return</span> number * factor;
  };
}

<span class="hljs-keyword">const</span> triple = <span class="hljs-title function_">makeMultiplier</span>(<span class="hljs-number">3</span>);
</code></pre><p><strong>Analysis:</strong></p>
<ol>
<li>Inner function: <code>function(number) { ... }</code></li>
<li>Outer variable referenced: <code>factor</code></li>
<li>Escapes: Yes, returned from <code>makeMultiplier</code></li>
<li>Lifetime: <code>factor</code> (value 3) stays in memory as long as <code>triple</code> exists</li>
<li>Memory concerns: Minimal, only stores one number</li>
</ol>
<h3 id="scope-encapsulation-pattern">Scope Encapsulation Pattern</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserManager</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// Private variables</span>
  <span class="hljs-keyword">let</span> users = [];
  <span class="hljs-keyword">let</span> currentId = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// Private functions</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateId</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> ++currentId;
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateUser</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-keyword">return</span> user.<span class="hljs-property">name</span> &amp;&amp; user.<span class="hljs-property">email</span>;
  }

  <span class="hljs-comment">// Public API</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">addUser</span>(<span class="hljs-params">name, email</span>) {
      <span class="hljs-keyword">const</span> user = {
        <span class="hljs-attr">id</span>: <span class="hljs-title function_">generateId</span>(),
        name,
        email,
        <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      };

      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validateUser</span>(user)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Invalid user data&#x27;</span>);
      }

      users.<span class="hljs-title function_">push</span>(user);
      <span class="hljs-keyword">return</span> user;
    },

    <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span> === id);
    },

    <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"></span>) {
      <span class="hljs-comment">// Return copy to prevent external modification</span>
      <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> ({ ...u }));
    },

    <span class="hljs-title function_">removeUser</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">const</span> index = users.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span> === id);
      <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
        users.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },

    <span class="hljs-title function_">getUserCount</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> users.<span class="hljs-property">length</span>;
    }
  };
})();

<span class="hljs-comment">// Usage</span>
<span class="hljs-title class_">UserManager</span>.<span class="hljs-title function_">addUser</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>, <span class="hljs-string">&#x27;alice@example.com&#x27;</span>);
<span class="hljs-title class_">UserManager</span>.<span class="hljs-title function_">addUser</span>(<span class="hljs-string">&#x27;Bob&#x27;</span>, <span class="hljs-string">&#x27;bob@example.com&#x27;</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">UserManager</span>.<span class="hljs-title function_">getAllUsers</span>());
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">UserManager</span>.<span class="hljs-title function_">getUserCount</span>());  <span class="hljs-comment">// 2</span>

<span class="hljs-comment">// Private members are not accessible</span>
<span class="hljs-comment">// UserManager.users;  // undefined</span>
<span class="hljs-comment">// UserManager.generateId();  // Error</span>
</code></pre><h3 id="advanced-closure-with-private-state-and-methods">Advanced: Closure with Private State and Methods</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createStateMachine</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-keyword">let</span> state = initialState;
  <span class="hljs-keyword">const</span> transitions = {};
  <span class="hljs-keyword">const</span> listeners = [];

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">notify</span>(<span class="hljs-params">oldState, newState</span>) {
    listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>(oldState, newState));
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">getState</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> state;
    },

    <span class="hljs-title function_">addTransition</span>(<span class="hljs-params">fromState, toState, condition = () =&gt; <span class="hljs-literal">true</span></span>) {
      <span class="hljs-keyword">if</span> (!transitions[fromState]) {
        transitions[fromState] = [];
      }
      transitions[fromState].<span class="hljs-title function_">push</span>({ toState, condition });
    },

    <span class="hljs-title function_">transition</span>(<span class="hljs-params">toState</span>) {
      <span class="hljs-keyword">const</span> possibleTransitions = transitions[state] || [];
      <span class="hljs-keyword">const</span> validTransition = possibleTransitions.<span class="hljs-title function_">find</span>(
        <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">toState</span> === toState &amp;&amp; t.<span class="hljs-title function_">condition</span>()
      );

      <span class="hljs-keyword">if</span> (validTransition) {
        <span class="hljs-keyword">const</span> oldState = state;
        state = toState;
        <span class="hljs-title function_">notify</span>(oldState, state);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },

    <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">listener</span>) {
      listeners.<span class="hljs-title function_">push</span>(listener);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> index = listeners.<span class="hljs-title function_">indexOf</span>(listener);
        <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
          listeners.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
        }
      };
    }
  };
}

<span class="hljs-comment">// Usage: Traffic light</span>
<span class="hljs-keyword">const</span> trafficLight = <span class="hljs-title function_">createStateMachine</span>(<span class="hljs-string">&#x27;red&#x27;</span>);

trafficLight.<span class="hljs-title function_">addTransition</span>(<span class="hljs-string">&#x27;red&#x27;</span>, <span class="hljs-string">&#x27;green&#x27;</span>);
trafficLight.<span class="hljs-title function_">addTransition</span>(<span class="hljs-string">&#x27;green&#x27;</span>, <span class="hljs-string">&#x27;yellow&#x27;</span>);
trafficLight.<span class="hljs-title function_">addTransition</span>(<span class="hljs-string">&#x27;yellow&#x27;</span>, <span class="hljs-string">&#x27;red&#x27;</span>);

trafficLight.<span class="hljs-title function_">onStateChange</span>(<span class="hljs-function">(<span class="hljs-params">oldState, newState</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Light changed from <span class="hljs-subst">${oldState}</span> to <span class="hljs-subst">${newState}</span>`</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(trafficLight.<span class="hljs-title function_">getState</span>());  <span class="hljs-comment">// &#x27;red&#x27;</span>
trafficLight.<span class="hljs-title function_">transition</span>(<span class="hljs-string">&#x27;green&#x27;</span>);       <span class="hljs-comment">// &quot;Light changed from red to green&quot;</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(trafficLight.<span class="hljs-title function_">getState</span>());  <span class="hljs-comment">// &#x27;green&#x27;</span>
trafficLight.<span class="hljs-title function_">transition</span>(<span class="hljs-string">&#x27;yellow&#x27;</span>);      <span class="hljs-comment">// &quot;Light changed from green to yellow&quot;</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(trafficLight.<span class="hljs-title function_">getState</span>());  <span class="hljs-comment">// &#x27;yellow&#x27;</span>
</code></pre><h3 id="closure-scope-diagram">Closure Scope Diagram</h3>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">const</span> b = <span class="hljs-number">10</span>;

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">middle</span>(<span class="hljs-params">c</span>) {
    <span class="hljs-keyword">const</span> d = <span class="hljs-number">20</span>;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> f = <span class="hljs-number">30</span>;

      <span class="hljs-comment">// inner has access to ALL outer scopes</span>
      <span class="hljs-keyword">return</span> a + b + c + d + e + f;
    }

    <span class="hljs-keyword">return</span> inner;
  }

  <span class="hljs-keyword">return</span> middle;
}

<span class="hljs-keyword">const</span> mid = <span class="hljs-title function_">outer</span>(<span class="hljs-number">1</span>);     <span class="hljs-comment">// a=1, b=10 in closure</span>
<span class="hljs-keyword">const</span> inn = <span class="hljs-title function_">mid</span>(<span class="hljs-number">2</span>);       <span class="hljs-comment">// a=1, b=10, c=2, d=20 in closure</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">inn</span>(<span class="hljs-number">3</span>);    <span class="hljs-comment">// a=1, b=10, c=2, d=20, e=3, f=30</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);      <span class="hljs-comment">// 66</span>

<span class="hljs-comment">/*
Closure Scopes:

inner function has access to:
├─ f (own scope)
├─ e (parameter)
├─ d (middle scope)
├─ c (middle parameter)
├─ b (outer scope)
├─ a (outer parameter)
└─ global scope
*/</span>
</code></pre><hr>
<h2 id="summary">Summary</h2>
<h3 id="key-takeaways">Key Takeaways</h3>
<ol>
<li><strong>Closure</strong> = Function + Lexical environment</li>
<li><strong>Created</strong> when inner function references outer variables</li>
<li><strong>Persists</strong> even after outer function returns</li>
<li><strong>Enables</strong> data privacy, factories, callbacks, state management</li>
<li><strong>Watch for</strong> loop problems, memory leaks, unintended references</li>
</ol>
<h3 id="best-practices">Best Practices</h3>
<ul>
<li>Use closures for data privacy</li>
<li>Extract only needed values to avoid memory leaks</li>
<li>Use <code>let</code> in loops instead of <code>var</code></li>
<li>Be aware of what stays in memory</li>
<li>Return functions for reusability</li>
<li>Use IIFE for immediate execution</li>
<li>Consider arrow functions for context preservation</li>
</ul>
<h3 id="common-patterns">Common Patterns</h3>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// Private variables</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">let</span> private = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> private,
    <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> private = val
  };
}

<span class="hljs-comment">// Function factory</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeFunc</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> <span class="hljs-title function_">process</span>(input, config);
}

<span class="hljs-comment">// Module pattern</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">let</span> private = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">public</span>: <span class="hljs-function">() =&gt;</span> private };
})();

<span class="hljs-comment">// Event handler</span>
element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// Closure over element and outer variables</span>
});
</code></pre><h3 id="interview-questions-to-prepare">Interview Questions to Prepare</h3>
<ol>
<li>What is a closure?</li>
<li>How do closures work in loops?</li>
<li>What are memory implications of closures?</li>
<li>Give practical examples of closure usage</li>
<li>Explain the difference between closure and scope</li>
<li>How do you create private variables in JavaScript?</li>
<li>What is the module pattern?</li>
<li>How do closures relate to callbacks?</li>
</ol>
<div class="page-navigation">
            <a href="03-prototypal-inheritance.html" class="nav-btn nav-prev" data-nav="prev">
                <span class="nav-label">Previous</span>
                <span class="nav-title">Prototypal Inheritance</span>
            </a>
        
            <a href="05-context.html" class="nav-btn nav-next" data-nav="next">
                <span class="nav-label">Next</span>
                <span class="nav-title">Context (this)</span>
            </a>
        </div>
        <div class="progress-section">
            <div id="progress-controls"></div>
            <div class="notes-section">
                <h3>Your Notes</h3>
                <textarea id="page-notes" placeholder="Add your notes here... (saved automatically)"></textarea>
            </div>
        </div>
    
        <div id="markdown-source" style="display: none;"># Closures

## Table of Contents
- [Basic Definition and Concept](#basic-definition-and-concept)
- [Practical Scenarios](#practical-scenarios)
- [Importance of Closures](#importance-of-closures)
- [Common Issues and Pitfalls](#common-issues-and-pitfalls)
- [Example Implementations](#example-implementations)
- [Writing and Analyzing Closures](#writing-and-analyzing-closures)

---

## Basic Definition and Concept

### What is a Closure?

A **closure** is a function bundled together with references to its surrounding state (lexical environment).

**Key Points:**
- Function retains access to variables from outer scope
- Even after the outer function has returned
- Created every time a function is created
- Lexical scoping (based on where variables are declared)

### Simple Example

```javascript
function outer() {
  const message = "Hello";  // Variable in outer scope

  function inner() {
    console.log(message);  // Accesses outer variable
  }

  return inner;
}

const myFunc = outer();
myFunc(); // "Hello" - closure preserved access to message
```

### How It Works

```javascript
function makeCounter() {
  let count = 0;  // Private variable

  return function() {
    count++;  // Closure: access to count
    return count;
  };
}

const counter = makeCounter();
console.log(counter()); // 1
console.log(counter()); // 2
console.log(counter()); // 3

// Each call to makeCounter creates a new closure
const counter2 = makeCounter();
console.log(counter2()); // 1 (independent count)
```

### Lexical Scoping

```javascript
const globalVar = "global";

function outer() {
  const outerVar = "outer";

  function middle() {
    const middleVar = "middle";

    function inner() {
      const innerVar = "inner";

      // Inner function has access to ALL outer scopes
      console.log(innerVar);   // "inner"
      console.log(middleVar);  // "middle"
      console.log(outerVar);   // "outer"
      console.log(globalVar);  // "global"
    }

    return inner;
  }

  return middle();
}

const myFunc = outer();
myFunc();
```

---

## Practical Scenarios

### 1. Data Privacy / Encapsulation

Create private variables that can't be accessed directly.

```javascript
function createBankAccount(initialBalance) {
  // Private variable
  let balance = initialBalance;

  // Public interface
  return {
    deposit(amount) {
      if (amount &gt; 0) {
        balance += amount;
        return balance;
      }
    },

    withdraw(amount) {
      if (amount &gt; 0 && amount &lt;= balance) {
        balance -= amount;
        return balance;
      }
      throw new Error("Insufficient funds");
    },

    getBalance() {
      return balance;
    }
  };
}

const account = createBankAccount(100);
account.deposit(50);
console.log(account.getBalance());  // 150
account.withdraw(30);
console.log(account.getBalance());  // 120

// balance is private - no direct access
console.log(account.balance);  // undefined
// account.balance = 99999;  // Doesn't affect actual balance
```

### 2. Function Factories

Create specialized functions with preset configuration.

```javascript
function makeMultiplier(multiplier) {
  return function(number) {
    return number * multiplier;
  };
}

const double = makeMultiplier(2);
const triple = makeMultiplier(3);
const quadruple = makeMultiplier(4);

console.log(double(5));      // 10
console.log(triple(5));      // 15
console.log(quadruple(5));   // 20

// More practical example: greeting function
function makeGreeter(greeting) {
  return function(name) {
    return `${greeting}, ${name}!`;
  };
}

const sayHello = makeGreeter("Hello");
const sayHi = makeGreeter("Hi");
const sayGoodbye = makeGreeter("Goodbye");

console.log(sayHello("Alice"));    // "Hello, Alice!"
console.log(sayHi("Bob"));         // "Hi, Bob!"
console.log(sayGoodbye("Charlie")); // "Goodbye, Charlie!"
```

### 3. Event Handlers and Callbacks

Preserve context and data for async operations.

```javascript
function setupButtons() {
  const buttons = ["Login", "Signup", "Logout"];

  buttons.forEach((buttonText, index) =&gt; {
    const button = document.createElement('button');
    button.textContent = buttonText;

    // Closure preserves buttonText and index
    button.addEventListener('click', function() {
      console.log(`Button ${index}: ${buttonText} clicked`);
    });

    document.body.appendChild(button);
  });
}

// Another example: timer with specific message
function delayedMessage(message, delay) {
  setTimeout(function() {
    console.log(message);  // Closure over message
  }, delay);
}

delayedMessage("First", 1000);
delayedMessage("Second", 2000);
delayedMessage("Third", 3000);
```

### 4. Partial Application and Currying

```javascript
// Partial application
function add(a, b, c) {
  return a + b + c;
}

function partial(fn, ...fixedArgs) {
  return function(...remainingArgs) {
    return fn(...fixedArgs, ...remainingArgs);
  };
}

const add5 = partial(add, 5);
console.log(add5(10, 15)); // 30 (5 + 10 + 15)

// Currying
function curry(fn) {
  return function curried(...args) {
    if (args.length &gt;= fn.length) {
      return fn.apply(this, args);
    }
    return function(...nextArgs) {
      return curried.apply(this, args.concat(nextArgs));
    };
  };
}

const curriedAdd = curry(add);
console.log(curriedAdd(1)(2)(3));     // 6
console.log(curriedAdd(1, 2)(3));     // 6
console.log(curriedAdd(1)(2, 3));     // 6
```

### 5. Module Pattern

Create modules with private and public members.

```javascript
const Calculator = (function() {
  // Private variables and functions
  let result = 0;

  function validateNumber(n) {
    if (typeof n !== 'number' || isNaN(n)) {
      throw new Error('Invalid number');
    }
  }

  // Public API
  return {
    add(n) {
      validateNumber(n);
      result += n;
      return this;
    },

    subtract(n) {
      validateNumber(n);
      result -= n;
      return this;
    },

    multiply(n) {
      validateNumber(n);
      result *= n;
      return this;
    },

    getResult() {
      return result;
    },

    reset() {
      result = 0;
      return this;
    }
  };
})();

Calculator.add(10).multiply(2).subtract(5);
console.log(Calculator.getResult());  // 15
Calculator.reset();
console.log(Calculator.getResult());  // 0

// Private members are not accessible
// Calculator.result;  // undefined
// Calculator.validateNumber(5);  // Error
```

### 6. Iterator Pattern

```javascript
function createIterator(array) {
  let index = 0;

  return {
    next() {
      if (index &lt; array.length) {
        return {
          value: array[index++],
          done: false
        };
      }
      return { done: true };
    },

    hasNext() {
      return index &lt; array.length;
    },

    reset() {
      index = 0;
    }
  };
}

const iterator = createIterator([1, 2, 3, 4, 5]);

console.log(iterator.next()); // { value: 1, done: false }
console.log(iterator.next()); // { value: 2, done: false }
console.log(iterator.hasNext()); // true
iterator.reset();
console.log(iterator.next()); // { value: 1, done: false }
```

---

## Importance of Closures

### 1. Data Privacy

Enable true private variables in JavaScript.

```javascript
function createUser(name) {
  let _password = null;  // Private

  return {
    getName() {
      return name;
    },

    setPassword(pwd) {
      _password = pwd;
    },

    checkPassword(pwd) {
      return _password === pwd;
    }
  };
}

const user = createUser("Alice");
user.setPassword("secret123");
console.log(user.checkPassword("secret123"));  // true
console.log(user._password);  // undefined (truly private)
```

### 2. Functional Programming

Foundation for many FP patterns.

```javascript
// Higher-order functions
const compose = (...fns) =&gt; x =&gt;
  fns.reduceRight((acc, fn) =&gt; fn(acc), x);

const add1 = x =&gt; x + 1;
const double = x =&gt; x * 2;
const square = x =&gt; x * x;

const compute = compose(square, double, add1);
console.log(compute(3));  // 64: ((3 + 1) * 2)^2 = (8)^2
```

### 3. Callbacks and Event Handling

Essential for asynchronous programming.

```javascript
function fetchData(url, onSuccess, onError) {
  // Closures preserve onSuccess and onError
  setTimeout(() =&gt; {
    if (url) {
      onSuccess({ data: "Success!" });
    } else {
      onError(new Error("Invalid URL"));
    }
  }, 1000);
}

fetchData(
  "https://api.example.com",
  (result) =&gt; console.log(result.data),
  (error) =&gt; console.error(error.message)
);
```

### 4. Maintaining State

Without global variables.

```javascript
function createGame() {
  let score = 0;
  let level = 1;
  let lives = 3;

  return {
    increaseScore(points) {
      score += points;
      if (score &gt; level * 100) {
        level++;
      }
    },

    loseLife() {
      lives--;
      if (lives === 0) {
        this.gameOver();
      }
    },

    gameOver() {
      console.log(`Game Over! Final score: ${score}, Level: ${level}`);
    },

    getStatus() {
      return { score, level, lives };
    }
  };
}

const game = createGame();
game.increaseScore(50);
console.log(game.getStatus());  // { score: 50, level: 1, lives: 3 }
```

---

## Common Issues and Pitfalls

### 1. Loop Closure Problem

**The Problem:**

```javascript
// ❌ WRONG: All callbacks reference the same i
for (var i = 0; i &lt; 3; i++) {
  setTimeout(function() {
    console.log(i);  // 3, 3, 3 (not 0, 1, 2!)
  }, 100);
}

// Why? By the time callbacks run, loop has finished
// All callbacks share the same i, which is now 3
```

**Solution 1: IIFE (Immediately Invoked Function Expression)**

```javascript
// ✅ CORRECT: IIFE creates new scope for each iteration
for (var i = 0; i &lt; 3; i++) {
  (function(j) {
    setTimeout(function() {
      console.log(j);  // 0, 1, 2
    }, 100);
  })(i);
}
```

**Solution 2: let (Block Scope)**

```javascript
// ✅ CORRECT: let creates new binding for each iteration
for (let i = 0; i &lt; 3; i++) {
  setTimeout(function() {
    console.log(i);  // 0, 1, 2
  }, 100);
}
```

**Solution 3: forEach**

```javascript
// ✅ CORRECT: forEach callback creates new scope
[0, 1, 2].forEach(function(i) {
  setTimeout(function() {
    console.log(i);  // 0, 1, 2
  }, 100);
});
```

### 2. Memory Leaks

Closures keep references to variables, which can prevent garbage collection.

**Problem:**

```javascript
// ❌ Memory leak: closure keeps reference to large data
function createHandler() {
  const largeData = new Array(1000000).fill('data');

  return function() {
    console.log(largeData.length);  // Entire array kept in memory
  };
}

const handler = createHandler();
// largeData can't be garbage collected
```

**Solution:**

```javascript
// ✅ Reference only what you need
function createHandler() {
  const largeData = new Array(1000000).fill('data');
  const dataLength = largeData.length;  // Extract needed value

  return function() {
    console.log(dataLength);  // Only number kept in memory
  };
}

const handler = createHandler();
// largeData can now be garbage collected
```

### 3. Accidental Global Variables

```javascript
// ❌ Forgot var/let/const - creates global!
function createCounter() {
  count = 0;  // Oops! Global variable

  return function() {
    count++;
    return count;
  };
}

const counter1 = createCounter();
const counter2 = createCounter();
console.log(counter1());  // 1
console.log(counter2());  // 2 (shared global count!)
```

**Solution:**

```javascript
// ✅ Always use var/let/const
function createCounter() {
  let count = 0;  // Local variable

  return function() {
    count++;
    return count;
  };
}

const counter1 = createCounter();
const counter2 = createCounter();
console.log(counter1());  // 1
console.log(counter2());  // 1 (independent counts)
```

### 4. Over-Closure

Closing over unnecessary variables.

```javascript
// ❌ Closes over entire obj even though only need id
function createGetter(obj) {
  return function() {
    return obj.id;  // Keeps entire object in memory
  };
}

// ✅ Extract only what you need
function createGetter(obj) {
  const id = obj.id;
  return function() {
    return id;  // Only keeps id in memory
  };
}
```

### 5. Closure in Callbacks with Wrong Context

```javascript
const obj = {
  value: 42,

  // ❌ This context lost in setTimeout
  getValue() {
    setTimeout(function() {
      console.log(this.value);  // undefined
    }, 100);
  }
};

// ✅ Solution 1: Arrow function (lexical this)
const obj1 = {
  value: 42,

  getValue() {
    setTimeout(() =&gt; {
      console.log(this.value);  // 42
    }, 100);
  }
};

// ✅ Solution 2: Store this reference
const obj2 = {
  value: 42,

  getValue() {
    const self = this;
    setTimeout(function() {
      console.log(self.value);  // 42
    }, 100);
  }
};

// ✅ Solution 3: bind
const obj3 = {
  value: 42,

  getValue() {
    setTimeout(function() {
      console.log(this.value);  // 42
    }.bind(this), 100);
  }
};
```

---

## Example Implementations

### 1. Private Variables with Closures

```javascript
function BankAccount(initialBalance) {
  // Private variables
  let balance = initialBalance;
  const transactionHistory = [];

  // Private function
  function recordTransaction(type, amount) {
    transactionHistory.push({
      type,
      amount,
      balance,
      date: new Date()
    });
  }

  // Public methods
  this.deposit = function(amount) {
    if (amount &lt;= 0) {
      throw new Error("Amount must be positive");
    }
    balance += amount;
    recordTransaction('deposit', amount);
    return balance;
  };

  this.withdraw = function(amount) {
    if (amount &lt;= 0) {
      throw new Error("Amount must be positive");
    }
    if (amount &gt; balance) {
      throw new Error("Insufficient funds");
    }
    balance -= amount;
    recordTransaction('withdraw', amount);
    return balance;
  };

  this.getBalance = function() {
    return balance;
  };

  this.getHistory = function() {
    // Return copy to prevent modification
    return [...transactionHistory];
  };
}

const account = new BankAccount(1000);
account.deposit(500);
account.withdraw(200);
console.log(account.getBalance());  // 1300
console.log(account.getHistory());  // Array of transactions

// Private variables are truly private
console.log(account.balance);  // undefined
```

### 2. Memoization (Caching)

```javascript
function memoize(fn) {
  const cache = {};

  return function(...args) {
    const key = JSON.stringify(args);

    if (key in cache) {
      console.log('Fetching from cache:', key);
      return cache[key];
    }

    console.log('Calculating result');
    const result = fn.apply(this, args);
    cache[key] = result;
    return result;
  };
}

// Expensive function
function fibonacci(n) {
  if (n &lt;= 1) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
}

const memoizedFib = memoize(fibonacci);

console.log(memoizedFib(40));  // Calculating result (takes time)
console.log(memoizedFib(40));  // Fetching from cache (instant!)

// Another example: API call caching
function fetchUser(userId) {
  return fetch(`/api/users/${userId}`).then(r =&gt; r.json());
}

const cachedFetchUser = memoize(fetchUser);
```

### 3. Once Function

Execute function only once, return cached result after.

```javascript
function once(fn) {
  let called = false;
  let result;

  return function(...args) {
    if (!called) {
      called = true;
      result = fn.apply(this, args);
    }
    return result;
  };
}

const initialize = once(() =&gt; {
  console.log("Initializing application...");
  return { initialized: true };
});

console.log(initialize());  // "Initializing application..." { initialized: true }
console.log(initialize());  // { initialized: true } (no log)
console.log(initialize());  // { initialized: true } (no log)

// Practical use: expensive initialization
const connectDatabase = once(() =&gt; {
  console.log("Connecting to database...");
  // Expensive connection logic
  return { connection: "db_connection" };
});
```

### 4. Debounce Function

Delay function execution until after a pause.

```javascript
function debounce(fn, delay) {
  let timeoutId;

  return function(...args) {
    // Clear previous timeout
    clearTimeout(timeoutId);

    // Set new timeout
    timeoutId = setTimeout(() =&gt; {
      fn.apply(this, args);
    }, delay);
  };
}

// Example: search input
const searchAPI = (query) =&gt; {
  console.log(`Searching for: ${query}`);
  // API call here
};

const debouncedSearch = debounce(searchAPI, 300);

// User types "hello"
debouncedSearch('h');    // Timeout set
debouncedSearch('he');   // Previous timeout cleared, new one set
debouncedSearch('hel');  // Previous timeout cleared, new one set
debouncedSearch('hell'); // Previous timeout cleared, new one set
debouncedSearch('hello');// Previous timeout cleared, new one set
// After 300ms of no typing: "Searching for: hello"
```

### 5. Throttle Function

Limit function execution to once per time period.

```javascript
function throttle(fn, limit) {
  let inThrottle;

  return function(...args) {
    if (!inThrottle) {
      fn.apply(this, args);
      inThrottle = true;

      setTimeout(() =&gt; {
        inThrottle = false;
      }, limit);
    }
  };
}

// Example: scroll event
const handleScroll = () =&gt; {
  console.log('Scroll position:', window.scrollY);
};

const throttledScroll = throttle(handleScroll, 1000);

// Will only log once per second, no matter how much user scrolls
window.addEventListener('scroll', throttledScroll);
```

### 6. Counter with Multiple Operations

```javascript
function createCounter(initialValue = 0) {
  let count = initialValue;
  const listeners = [];

  function notify() {
    listeners.forEach(listener =&gt; listener(count));
  }

  return {
    increment(step = 1) {
      count += step;
      notify();
      return count;
    },

    decrement(step = 1) {
      count -= step;
      notify();
      return count;
    },

    reset() {
      count = initialValue;
      notify();
      return count;
    },

    getValue() {
      return count;
    },

    subscribe(listener) {
      listeners.push(listener);
      return () =&gt; {
        const index = listeners.indexOf(listener);
        if (index &gt; -1) {
          listeners.splice(index, 1);
        }
      };
    }
  };
}

const counter = createCounter(10);

const unsubscribe = counter.subscribe((value) =&gt; {
  console.log(`Counter changed to: ${value}`);
});

counter.increment();    // "Counter changed to: 11"
counter.increment(5);   // "Counter changed to: 16"
counter.decrement(3);   // "Counter changed to: 13"
counter.reset();        // "Counter changed to: 10"

unsubscribe();
counter.increment();    // No log (unsubscribed)
```

---

## Writing and Analyzing Closures

### Analysis Checklist

When analyzing closure code:

1. **Identify inner function(s)**
2. **Find variables from outer scope referenced by inner function**
3. **Determine if inner function escapes outer scope** (returned, assigned, passed as callback)
4. **Trace variable lifetime** - what stays in memory?
5. **Check for potential memory leaks** or unintended references

### Example Analysis

```javascript
function makeMultiplier(factor) {
  return function(number) {
    return number * factor;
  };
}

const triple = makeMultiplier(3);
```

**Analysis:**
1. Inner function: `function(number) { ... }`
2. Outer variable referenced: `factor`
3. Escapes: Yes, returned from `makeMultiplier`
4. Lifetime: `factor` (value 3) stays in memory as long as `triple` exists
5. Memory concerns: Minimal, only stores one number

### Scope Encapsulation Pattern

```javascript
const UserManager = (function() {
  // Private variables
  let users = [];
  let currentId = 0;

  // Private functions
  function generateId() {
    return ++currentId;
  }

  function validateUser(user) {
    return user.name && user.email;
  }

  // Public API
  return {
    addUser(name, email) {
      const user = {
        id: generateId(),
        name,
        email,
        createdAt: new Date()
      };

      if (!validateUser(user)) {
        throw new Error('Invalid user data');
      }

      users.push(user);
      return user;
    },

    getUser(id) {
      return users.find(u =&gt; u.id === id);
    },

    getAllUsers() {
      // Return copy to prevent external modification
      return users.map(u =&gt; ({ ...u }));
    },

    removeUser(id) {
      const index = users.findIndex(u =&gt; u.id === id);
      if (index &gt; -1) {
        users.splice(index, 1);
        return true;
      }
      return false;
    },

    getUserCount() {
      return users.length;
    }
  };
})();

// Usage
UserManager.addUser('Alice', 'alice@example.com');
UserManager.addUser('Bob', 'bob@example.com');
console.log(UserManager.getAllUsers());
console.log(UserManager.getUserCount());  // 2

// Private members are not accessible
// UserManager.users;  // undefined
// UserManager.generateId();  // Error
```

### Advanced: Closure with Private State and Methods

```javascript
function createStateMachine(initialState) {
  let state = initialState;
  const transitions = {};
  const listeners = [];

  function notify(oldState, newState) {
    listeners.forEach(listener =&gt; listener(oldState, newState));
  }

  return {
    getState() {
      return state;
    },

    addTransition(fromState, toState, condition = () =&gt; true) {
      if (!transitions[fromState]) {
        transitions[fromState] = [];
      }
      transitions[fromState].push({ toState, condition });
    },

    transition(toState) {
      const possibleTransitions = transitions[state] || [];
      const validTransition = possibleTransitions.find(
        t =&gt; t.toState === toState && t.condition()
      );

      if (validTransition) {
        const oldState = state;
        state = toState;
        notify(oldState, state);
        return true;
      }

      return false;
    },

    onStateChange(listener) {
      listeners.push(listener);
      return () =&gt; {
        const index = listeners.indexOf(listener);
        if (index &gt; -1) {
          listeners.splice(index, 1);
        }
      };
    }
  };
}

// Usage: Traffic light
const trafficLight = createStateMachine('red');

trafficLight.addTransition('red', 'green');
trafficLight.addTransition('green', 'yellow');
trafficLight.addTransition('yellow', 'red');

trafficLight.onStateChange((oldState, newState) =&gt; {
  console.log(`Light changed from ${oldState} to ${newState}`);
});

console.log(trafficLight.getState());  // 'red'
trafficLight.transition('green');       // "Light changed from red to green"
console.log(trafficLight.getState());  // 'green'
trafficLight.transition('yellow');      // "Light changed from green to yellow"
console.log(trafficLight.getState());  // 'yellow'
```

### Closure Scope Diagram

```javascript
function outer(a) {
  const b = 10;

  function middle(c) {
    const d = 20;

    function inner(e) {
      const f = 30;

      // inner has access to ALL outer scopes
      return a + b + c + d + e + f;
    }

    return inner;
  }

  return middle;
}

const mid = outer(1);     // a=1, b=10 in closure
const inn = mid(2);       // a=1, b=10, c=2, d=20 in closure
const result = inn(3);    // a=1, b=10, c=2, d=20, e=3, f=30
console.log(result);      // 66

/*
Closure Scopes:

inner function has access to:
├─ f (own scope)
├─ e (parameter)
├─ d (middle scope)
├─ c (middle parameter)
├─ b (outer scope)
├─ a (outer parameter)
└─ global scope
*/
```

---

## Summary

### Key Takeaways

1. **Closure** = Function + Lexical environment
2. **Created** when inner function references outer variables
3. **Persists** even after outer function returns
4. **Enables** data privacy, factories, callbacks, state management
5. **Watch for** loop problems, memory leaks, unintended references

### Best Practices

- Use closures for data privacy
- Extract only needed values to avoid memory leaks
- Use `let` in loops instead of `var`
- Be aware of what stays in memory
- Return functions for reusability
- Use IIFE for immediate execution
- Consider arrow functions for context preservation

### Common Patterns

```javascript
// Private variables
function create() {
  let private = 0;
  return {
    get: () =&gt; private,
    set: (val) =&gt; private = val
  };
}

// Function factory
function makeFunc(config) {
  return (input) =&gt; process(input, config);
}

// Module pattern
const module = (function() {
  let private = 0;
  return { public: () =&gt; private };
})();

// Event handler
element.addEventListener('click', function() {
  // Closure over element and outer variables
});
```

### Interview Questions to Prepare

1. What is a closure?
2. How do closures work in loops?
3. What are memory implications of closures?
4. Give practical examples of closure usage
5. Explain the difference between closure and scope
6. How do you create private variables in JavaScript?
7. What is the module pattern?
8. How do closures relate to callbacks?
</div>
    
    </main>

    <!-- Back to Top Button -->
    <button id="back-to-top" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Search Modal -->
    <div id="search-modal" class="modal">
        <div class="modal-content search-content">
            <div class="search-header">
                <input type="text" id="search-input" placeholder="Search topics..." autofocus>
                <button id="search-close" aria-label="Close search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="search-results" class="search-results"></div>
            <div class="search-footer">
                <span><i class="fas fa-arrows-alt-v"></i> Navigate</span>
                <span><i class="fas fa-level-down-alt"></i> Select</span>
                <span>Esc Close</span>
            </div>
        </div>
    </div>

    <!-- Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal">
        <div class="modal-content shortcuts-modal-content">
            <div class="modal-header">
                <h2>Keyboard Shortcuts</h2>
                <button id="shortcuts-close" aria-label="Close shortcuts">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="shortcuts-content"></div>
        </div>
    </div>

    <!-- Auto-Generate Confirmation Modal -->
    <div id="generate-modal" class="modal">
        <div class="modal-content generate-content">
            <div class="modal-header">
                <h2><i class="fas fa-magic"></i> Auto-Generate Flashcards</h2>
                <button id="generate-close" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="generate-body">
                <!-- AI Toggle -->
                <div class="ai-toggle-section">
                    <label class="toggle-label">
                        <input type="checkbox" id="use-ai-toggle">
                        <span class="toggle-text">
                            <i class="fas fa-robot"></i> Use AI-Powered Generation
                            <small>(More diverse & intelligent questions)</small>
                        </span>
                    </label>
                </div>

                <!-- AI Settings (shown when toggle is ON) -->
                <div id="ai-settings-section" class="ai-settings hidden">
                    <div class="form-group">
                        <label for="ai-provider-select">AI Provider:</label>
                        <select id="ai-provider-select">
                            <option value="groq" selected>Groq (Recommended - Free & Fast)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="huggingface">Hugging Face</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="ai-api-key-input">
                            API Key:
                            <a href="#" id="get-api-key-link" target="_blank" class="help-link">
                                <i class="fas fa-external-link-alt"></i> Get Free Key
                            </a>
                        </label>
                        <input type="password" id="ai-api-key-input" placeholder="Enter your API key">
                        <small class="help-text">Your key is stored locally and never shared</small>
                    </div>

                    <div class="form-group">
                        <label for="questions-per-section">Questions per Section:</label>
                        <input type="number" id="questions-per-section" value="3" min="1" max="10">
                    </div>

                    <div class="form-group">
                        <label for="question-diversity">Question Diversity:</label>
                        <select id="question-diversity">
                            <option value="low">Low (Similar questions)</option>
                            <option value="medium">Medium (Balanced)</option>
                            <option value="high" selected>High (Maximum variety)</option>
                        </select>
                    </div>

                    <button id="test-ai-connection" class="action-btn">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <div id="ai-test-result" class="test-result hidden"></div>
                </div>

                <!-- Pattern Matching Stats (shown when AI is OFF) -->
                <div id="pattern-stats-section" class="generate-stats">
                    <p>Found <strong id="gen-total-count">0</strong> potential flashcards:</p>
                    <div class="gen-breakdown">
                        <div><i class="fas fa-heading"></i> From headings: <span id="gen-heading-count">0</span></div>
                        <div><i class="fas fa-book"></i> From definitions: <span id="gen-def-count">0</span></div>
                        <div><i class="fas fa-list"></i> From lists: <span id="gen-list-count">0</span></div>
                        <div><i class="fas fa-code"></i> From code: <span id="gen-code-count">0</span></div>
                    </div>
                </div>

                <div class="generate-preview">
                    <h3>Preview:</h3>
                    <ul id="generate-preview-list"></ul>
                </div>
                <div class="generate-actions">
                    <button id="generate-cancel-btn" class="action-btn">Cancel</button>
                    <button id="generate-confirm-btn" class="action-btn primary">
                        <i class="fas fa-magic"></i> <span id="generate-btn-text">Generate All</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div id="add-card-modal" class="modal">
        <div class="modal-content add-card-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Add Flashcard</h2>
                <button id="add-card-close" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="add-card-body">
                <div class="form-group">
                    <label for="card-question">Question:</label>
                    <textarea id="card-question" rows="3" placeholder="Enter the question..."></textarea>
                </div>
                <div class="form-group">
                    <label for="card-answer">Answer:</label>
                    <textarea id="card-answer" rows="5" placeholder="Enter the answer..."></textarea>
                </div>
                <div class="add-card-actions">
                    <button id="save-card-btn" class="action-btn primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/nav.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/search.js"></script>
    <script src="js/shortcuts.js"></script>
    <script src="js/flashcards.js"></script>
    <script src="js/ai-flashcard-generator.js"></script>
    <script src="js/flashcards-ui.js"></script>
</body>

</html>
